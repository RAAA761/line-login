<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>LINEOC ログイン</title>
  <style>
    body {
      font-family: "Helvetica Neue", sans-serif;
      background: #f8f9fa;
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .login-container {
      width: 400px;
      background: #ffffff;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-radius: 8px;
    }

    h2 {
      text-align: center;
      margin-bottom: 30px;
    }

    label {
      display: block;
      margin-bottom: 18px;
    }

    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 12px;
      font-size: 1.1em;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 6px;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 12px;
      font-size: 1.1em;
      margin-top: 12px;
      background-color: #4f92ff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #3878db;
    }

    #pincode {
      display: none;
      text-align: center;
      margin-top: 24px;
      font-size: 2em;
      font-weight: bold;
      color: #4f92ff;
    }

    #redirectInfo {
      margin-top: 24px;
      text-align: center;
      font-size: 1em;
      color: #444;
    }

    #copyLink {
      margin-top: 8px;
      background: #eee;
      color: #333;
      border: 1px solid #ccc;
      cursor: pointer;
      font-size: 0.95em;
      padding: 8px 12px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
<div class="login-container">
  <h2>LINEOC ログイン</h2>

  <label>メールアドレス
    <input type="email" id="email" required>
  </label>
  <label>パスワード
    <input type="password" id="password" required>
  </label>

  <button id="login">PINコード取得</button>

  <div id="pincode">PIN: <span id="pincodeValue"></span></div>

  <button id="getTokenBtn" style="display:none;">AuthToken を取得</button>

  <div id="redirectInfo" style="display:none;">
    5 秒後に操作ページへ移動します<br>
    <button id="copyLink">操作用ページのリンクをコピー</button>
  </div>
</div>

<script>
const storageKey = "lineoc-session-id";
let sessionId     = localStorage.getItem(storageKey) || null;

const $ = id => document.getElementById(id);
const uaIsMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);

/* --- ① PIN 取得 --- */
$("login").onclick = async () => {
  const email = $("email").value.trim();
  const pw    = $("password").value.trim();
  if (!email || !pw) return alert("メールとパスワードを入力して下さい");

  const r = await fetch("/api/login", {
    method : "POST",
    headers: {"Content-Type":"application/json"},
    body   : JSON.stringify({ email, password: pw, device:"IOSIPAD" })
  });
  const j = await r.json();

  sessionId = j.sessionId;
  localStorage.setItem(storageKey, sessionId);

  $("pincodeValue").textContent = j.pincode;
  $("pincode").style.display = "block";
  $("getTokenBtn").style.display = "inline-block";
};

/* --- ② AuthToken 取得 --- */
$("getTokenBtn").onclick = fetchToken;

async function fetchToken() {
  if (!sessionId) return alert("セッションがありません");
  $("getTokenBtn").disabled = true;

  const r = await fetch("/api/result?sid=" + encodeURIComponent(sessionId));
  const j = await r.json();

  if (j.status === "OK") {
    const link =
      `https://line-extension.deno.dev/?token=${j.token}&refresh=${j.refresh}`;
    showLink(link);
  } else if (j.status === "PENDING") {
    alert("まだ認証が完了していません。少し待ってから再度押して下さい。");
    $("getTokenBtn").disabled = false;
  } else {
    alert(j.error || "エラー");
    $("getTokenBtn").disabled = false;
  }
}

/* --- ③ ページが再びアクティブになったら（モバイルのみ）自動クリック --- */
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible" && uaIsMobile && sessionId) {
    $("getTokenBtn").click();
  }
});

/* --- ④ スマホでは戻って来た瞬間にも実行されるよう pageshow --- */
window.addEventListener("pageshow", (ev) => {
  if (uaIsMobile && sessionId && ev.persisted) $("getTokenBtn").click();
});

/* --- リンク表示 & 自動リダイレクト --- */
function showLink(link) {
  const info = $("redirectInfo");
  const btn  = $("copyLink");
  info.style.display = "block";
  btn.onclick = () =>
    navigator.clipboard.writeText(link)
      .then(()=>btn.textContent="コピーしました！")
      .catch(()=>btn.textContent="コピー失敗....");
  setTimeout(() => location.href = link, 5000);
}
</script>
</body>
</html>